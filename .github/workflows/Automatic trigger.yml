# 文件名: .github/workflows/trigger_on_external_build.yml
name: Trigger Kernel Build on SukiSU-Ultra Update or Manual Dispatch

on:
  workflow_run:
    workflows: ["Build Manager CI/CD"] # 确保这个名称与 ShirkNeko/SukiSU-Ultra 仓库中目标工作流的 'name' 字段完全一致
    repository: ShirkNeko/SukiSU-Ultra
    types:
      - completed
  workflow_dispatch:

jobs:
  trigger_kernel_workflow:
    name: Trigger Local Kernel Build
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write # 需要此权限来触发其他工作流

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Trigger build-kernel.yml
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TRIGGER_PAT }} # 确保这个 PAT 有 'workflow' 权限
        run: |
          # 使用 ${{ github.event_name }} 来获取正确的事件名称
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "监听到 ShirkNeko/SukiSU-Ultra 仓库的 'Build Manager CI/CD' 工作流成功完成。"
            echo "触发者: ${{ github.event.workflow_run.actor.login }}"
            echo "外部工作流运行 ID: ${{ github.event.workflow_run.id }}"
            echo "外部工作流提交 SHA: ${{ github.event.workflow_run.head_sha }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "工作流由 ${{ github.actor }} 手动触发。"
          fi

          echo "正在尝试触发本地的 'build-kernel.yml' 工作流..."

          # 确定目标分支
          # 对于 workflow_run, github.ref 是此触发工作流所在仓库的默认分支的 ref (例如 refs/heads/main)
          # 对于 workflow_dispatch, github.ref 是用户选择运行此工作流的分支的 ref
          TARGET_REF="${{ github.ref }}"
          echo "将在分支 ${TARGET_REF} 上触发 build-kernel.yml"

          # 使用 GitHub CLI (gh) 来触发仓库中的 'build-kernel.yml' 工作流
          # **重要**: 确保你的 Celestials316/Build-your-own-kernel 仓库中
          # .github/workflows/ 目录下的文件确实名为 'build-kernel.yml' (有 'd')
          # 并且该文件位于 ${TARGET_REF} 指定的分支上。
          gh workflow run build-kernel.yml --ref ${TARGET_REF}

          echo "已发送 'build-kernel.yml' 的触发命令。"
          echo "你可以在 Actions 标签页查看 'build-kernel.yml' 的运行状态。"